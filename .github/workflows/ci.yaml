name: CI Pipeline

on:
  push:
    branches:
      - 'feature/**'
      - 'release/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - 'develop'
      - 'staging'
      - 'master'

env:
    GO_VERSION: "1.25"
    DOCKER_REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    build-and-test:
        name: Build and Test
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ env.GO_VERSION }}
                  cache: false

            - name: Check Formatting (go fmt)
              run: |
                  if [ -n "$(gofmt -l .)" ]; then
                      echo "::error file=go.mod::Go files must be formatted with gofmt. Run 'gofmt -w .' to fix."
                      gofmt -d .
                      exit 1
                  fi

            - name: Run GoLinters
              uses: golangci/golangci-lint-action@v8
              with:
                  only-new-issues: true
                  version: latest
                  args: --timeout=5m --verbose
                  
            - name: Build
              run: go build -v ./...

            - name: Run Unit Tests with coverage
              run: |
                  go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
                  go tool cover -html=coverage.out -o coverage.html

            - name: Show Coverage Summary
              run: go tool cover -func=coverage.out

            - name: Upload Go test results
              uses: actions/upload-artifact@v4
              with:
                  name: test-result
                  path: coverage.html
